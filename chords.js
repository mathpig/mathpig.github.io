'use strict';

var RATE = 2.5;
var FINGERS = 10;

function Song(startTime, score) {
  var ctx = new AudioContext();
  var oscillators = [];
  var gains = [];
  var merger = ctx.createChannelMerger(FINGERS);
  for (var i = 0; i < FINGERS; i++) {
    var g = ctx.createGain();
    var o = ctx.createOscillator();
    o.type = 'square';
    o.connect(g);
    g.connect(merger, 0, i);
    gains.push(g);
    oscillators.push(o);
  }
  merger.connect(ctx.destination);
  var tm = startTime;
  function rawChord(keys, duration) {
    for (var i = 0; i < FINGERS; i++) {
      if (i < keys.length) {
        oscillators[i].frequency.setValueAtTime(440 * Math.pow(2, (keys[keys.length - 1 - i] - 36) / 12), tm);
        gains[i].gain.setValueAtTime(1, tm);
      } else {
        gains[i].gain.setValueAtTime(0, tm);
      }
    }
    tm += duration * RATE;
  }

  function chord(keys, duration) {
    var gap = RATE / 128;
    if (duration < 1 / 32) {
      gap = duration * 1 / 8;
    }
    rawChord(keys, duration - gap);
    rawChord([], gap);
  }

  chord([], 1); 
  for (var i = 0; i < score.length; ++i) {
    chord(score[i], 0.2);
  }
  return function() {
    for (var i = 0; i < FINGERS; ++i) {
      oscillators[i].start();
    }
  }
}

document.getElementById('play').onclick = function() {
  RATE = 2;
  var now = new AudioContext().currentTime;
  var play = Song(now, [
    [ 31, 36, 40 ],
    [ 31, 35, 38, 41 ],
    [ 33, 36, 40 ],
    [ 31, 35, 38, 41 ],
    [ 33, 36, 40 ],
    [ 31, 35, 38 ],
    [ 33, 36, 40 ],
    [ 31, 35, 38 ],
    [ 29, 31, 35, 38 ],
    [ 31, 35, 38, 41 ],
    [ 35, 38, 41, 43 ],
    [ 36, 40, 43 ],
    [ 33, 36, 41 ],
    [ 31, 36, 40 ],
    [ 33, 38, 41 ],
    [ 33, 36, 41 ],
    [ 35, 38, 43 ],
    [ 36, 40, 43 ],
    [ 40, 43, 48 ],
    [ 38, 41, 43, 47 ],
    [ 41, 43, 47, 50 ],
    [ 40, 45, 48 ],
    [ 36, 40, 45 ],
    [ 40, 45, 48 ],
    [ 38, 41, 43, 47 ],
    [ 40, 43, 48 ],
    [ 36, 40, 43 ],
    [ 38, 41, 45 ],
    [ 36, 41, 45 ],
    [ 35, 38, 41, 43 ],
    [ 36, 40, 43 ],
  ]);
  play();
};

document.getElementById('play2').onclick = function() {
  RATE = 2;
  var now = new AudioContext().currentTime;
  var play = Song(now, [
    [ 34, 38, 41 ],
    [ 33, 36, 41 ],
    [ 34, 38, 43 ],
    [ 38, 43, 46 ],
    [ 43, 46, 50 ],
    [ 41, 45, 48 ],
    [ 43, 46, 50 ],
    [ 38, 43, 46 ],
    [ 36, 41, 45 ],
    [ 38, 43, 46 ],
    [ 36, 41, 45 ],
    [ 36, 39, 41, 45 ],
    [ 38, 41, 46 ],
    [ 39, 43, 48 ],
    [ 36, 39, 43 ],
    [ 39, 43, 48 ],
    [ 36, 39, 43 ],
    [ 34, 39, 43 ],
    [ 39, 43, 46 ],
    [ 38, 41, 46 ],
    [ 38, 43, 46 ],
    [ 34, 38, 43 ],
    [ 33, 36, 39, 41 ],
    [ 34, 38, 43 ],
    [ 31, 34, 38 ],
    [ 26, 31, 34 ],
    [ 24, 29, 33 ],
    [ 26, 29, 34 ],
    [ 27, 31, 36 ],
    [ 27, 31, 34 ],
    [ 24, 27, 29, 33 ],
    [ 26, 31, 34 ],
    [ 31, 34, 38 ],
    [ 26, 31, 34 ],
    [ 24, 29, 33 ],
    [ 26, 31, 34 ],
    [ 24, 27, 29, 33 ],
    [ 26, 31, 34 ],
    [ 22, 26, 31 ],
    [ 19, 22, 26 ],
    [ 17, 21, 24, 27 ],
    [ 17, 22, 26 ],
    [],
    [],
    [ 28, 31, 36 ],
    [ 26, 29, 31, 35 ],
    [ 28, 33, 36 ],
    [ 24, 28, 33 ],
    [ 28, 33, 36 ],
    [ 26, 29, 31, 35 ],
    [ 23, 26, 29, 31 ],
    [ 24, 28, 33 ],
    [ 26, 31, 35 ],
    [ 26, 29, 31, 35 ],
    [ 28, 31, 36 ],
    [ 26, 31, 35 ],
    [ 28, 31, 36 ],
    [ 29, 33, 36 ],
    [ 26, 29, 31, 35 ],
    [ 28, 33, 36 ],
    [ 26, 31, 35 ],
    [ 28, 31, 36 ],
    [ 29, 33, 36 ],
    [ 24, 29, 33 ],
    [ 23, 26, 31 ],
    [ 24, 28, 31 ],
    [ 26, 29, 33 ],
    [ 21, 26, 29 ],
    [ 26, 29, 33 ],
    [ 21, 26, 29 ],
    [ 17, 21, 26 ],
    [ 17, 21, 24 ],
    [ 21, 24, 29 ],
    [ 19, 24, 28 ],
    [],
    [ 28, 31, 35 ],
    [ 27, 30, 33, 35 ],
    [ 28, 31, 35 ],
    [ 28, 33, 36 ],
    [ 28, 31, 35 ],
    [ 28, 31, 36 ],
    [ 31, 36, 40 ],
    [ 30, 33, 35, 39 ],
    [ 27, 30, 33, 35 ],
    [ 28, 31, 36 ],
    [ 24, 28, 31 ],
    [ 23, 27, 30 ],
    [ 23, 28, 31 ],
    [ 24, 28, 31 ],
    [ 28, 31, 36 ],
    [ 24, 28, 31 ],
    [ 19, 24, 28 ],
    [ 18, 23, 27 ],
    [ 18, 21, 23, 27 ],
    [ 19, 24, 28 ],
    [ 18, 21, 23, 27 ],
    [ 19, 24, 28 ],
    [ 18, 23, 27 ],
    [ 19, 24, 28 ],
    [ 18, 21, 23, 27 ],
    [ 19, 23, 28 ],
    [ 21, 24, 28 ],
    [ 19, 23, 28 ],
    [ 21, 24, 28 ],
    [ 19, 23, 28 ],
  ]);
  play();
};

document.getElementById('play3').onclick = function() {
  RATE = 2;
  var now = new AudioContext().currentTime;
  var play = Song(now, [

    [ 34, 38, 43, 67 ],
    [ 34, 39, 43, 67 ],
    [ 31, 34, 39, 55 ],
    [ 27, 31, 34, 55 ],
    [ 31, 34, 39, 58 ],
    [ 27, 31, 34, 55 ],
    [ 22, 27, 31, 55 ],
    [ 19, 22, 27, 51 ],
    [ 18, 21, 24, 26, 42 ],
    [ 19, 22, 27, 46 ],
    [ 18, 21, 26, 42 ],
    [ 19, 22, 26, 43 ],
    [ 21, 24, 27, 45 ],
    [ 18, 21, 26, 45 ],
    [ 19, 22, 26, 43 ],
    [ 19, 24, 27, 48 ],
    [ 15, 19, 24, 43 ],
    [ 19, 24, 27, 48 ],
    [ 24, 27, 31, 51 ],
    [ 19, 24, 27, 43 ],
    [ 19, 22, 26, 43 ],
    [ 19, 22, 27, 46 ],
    [ 15, 19, 22, 43 ],
    [ 18, 21, 24, 26, 50 ],
    [ 19, 22, 26, 46 ],
    [ 21, 24, 27, 48 ],
    [ 18, 21, 26, 50 ],
    [ 14, 18, 21, 38 ],
    [ 19, 22, 26, 43 ],
    [ 19, 24, 27, 43 ],
    [ 24, 27, 31, 55 ],
    [ 27, 31, 36, 55 ],
    [ 24, 27, 31, 55 ],
    [ 27, 31, 36, 60 ],
    [ 31, 34, 38, 58 ],
    [],
    [],

    [ 36, 39, 44, 60 ],
    [ 36, 41, 44, 68 ],
    [ 32, 36, 41, 60 ],
    [ 29, 32, 36, 60 ],
    [ 27, 31, 34, 55 ],
    [ 29, 32, 36, 56 ],
    [ 27, 31, 34, 55 ],
    [ 22, 27, 31, 55 ],
    [ 27, 31, 34, 58 ],
    [ 24, 29, 32, 53 ],
    [ 20, 24, 29, 44 ],
    [ 17, 20, 24, 41 ],
    [ 15, 19, 22, 46 ],
    [ 17, 20, 24, 48 ],
    [ 15, 19, 22, 43 ],
    [ 15, 19, 22, 25, 43 ],
    [ 15, 20, 24, 48 ],
    [ 17, 20, 24, 41 ],
    [ 15, 19, 22, 39 ],
    [ 15, 20, 24, 39 ],
    [ 17, 20, 25, 49 ],
    [ 13, 17, 20, 41 ],
    [ 17, 20, 25, 44 ],
    [ 15, 20, 24, 44 ],
    [ 15, 19, 22, 25, 43 ],
    [ 15, 20, 24, 48 ],
    [ 17, 20, 25, 49 ],
    [ 15, 20, 24, 44 ],
    [ 20, 24, 27, 48 ],
    [ 15, 20, 24, 44 ],
  ]);
  play();
};

